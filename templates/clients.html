{% extends "base.html" %}

{% block page_title %}Clients{% endblock %}

{% block content %}
<!-- Add New Client Form -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title">
                    <i class="bi bi-person-plus"></i>
                    Add New Client
                </h6>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('add_client') }}">
                    <div class="mb-3">
                        <label for="client_name" class="form-label">Client Name</label>
                        <input type="text" class="form-control" id="client_name" name="client_name" 
                               placeholder="Enter client name" required
                               pattern="[a-zA-Z0-9_-]+"
                               title="Only letters, numbers, underscores and hyphens">
                        <div class="form-text">Only letters, numbers, underscores and hyphens are allowed</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="client_group" class="form-label">
                            <i class="bi bi-people"></i> Assign to Group
                        </label>
                        <select class="form-select" id="client_group" name="client_group">
                            <option value="">No Group (Individual Access)</option>
                            <option value="admins">👑 Administrators - Full Access</option>
                            <option value="users" selected>👤 Regular Users - Standard Access</option>
                            <option value="guests">👥 Guests - Limited Access</option>
                            <option value="developers">💻 Developers - Dev Environment</option>
                            <option value="managers">📊 Managers - Management Access</option>
                            <option value="external">🌐 External Partners - External Access</option>
                            <option value="custom">✨ Create New Group...</option>
                        </select>
                        
                        <div class="custom-group-input mt-2" style="display: none;">
                            <input type="text" class="form-control" id="custom_group_name" name="custom_group_name" 
                                   placeholder="Enter new group name" pattern="[a-zA-Z0-9_-]+">
                            <div class="form-text">Group names can contain letters, numbers, underscores and hyphens</div>
                        </div>
                        
                        <div class="form-text">Groups help organize clients with similar access levels and permissions</div>
                    </div>

                    <div class="mb-3">
                        <label for="client_profile" class="form-label">
                            <i class="bi bi-person-badge"></i> Client Profile
                        </label>
                        <select class="form-select" id="client_profile" name="client_profile">
                            <option value="standard">🔒 Standard Profile - Basic VPN access</option>
                            <option value="high_bandwidth">🚀 High Bandwidth - Streaming & Downloads</option>
                            <option value="restricted">⏱️ Time Limited - Business hours only</option>
                            <option value="mobile_only">📱 Mobile Only - Small data usage</option>
                            <option value="admin_access">👑 Admin Access - Full network access</option>
                            <option value="guest_limited">🎯 Guest Limited - Web browsing only</option>
                        </select>
                        <div class="form-text">Profile determines bandwidth limits, time restrictions, and access rules</div>
                    </div>
                    <div class="mb-3">
                        <label for="expiry_days" class="form-label">Certificate Validity Period</label>
                        <select class="form-control" id="expiry_days" name="expiry_days">
                            <option value="auto_1h">🕐 1 hour (Auto-revoke)</option>
                            <option value="auto_2h">🕑 2 hours (Auto-revoke)</option>
                            <option value="auto_6h">🕕 6 hours (Auto-revoke)</option>
                            <option value="auto_12h">🕛 12 hours (Auto-revoke)</option>
                            <option value="1">1 day (Quick Test)</option>
                            <option value="3">3 days (Short Test)</option>
                            <option value="7">1 week (Weekly Test)</option>
                            <option value="14">2 weeks (Bi-weekly Test)</option>
                            <option value="30">30 days (Trial)</option>
                            <option value="90">3 months</option>
                            <option value="180">6 months</option>
                            <option value="365" selected>1 year (Recommended)</option>
                            <option value="730">2 years</option>
                            <option value="1095">3 years</option>
                            <option value="3650">10 years (Legacy)</option>
                            <option value="custom">Custom...</option>
                        </select>
                        <div class="custom-days-input mt-2" style="display: none;">
                            <input type="number" class="form-control" id="custom_days" name="custom_days" 
                                   min="1" max="36500" placeholder="Enter days (1-36500)">
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-plus-circle me-1"></i>Add Client
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="showClientTemplates()" title="Use Client Template">
                            <i class="bi bi-file-earmark-text me-1"></i>Templates
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="enableMonitoring()" title="Enable Enhanced Monitoring">
                            <i class="bi bi-gear me-1"></i>Monitoring
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title">
                    <i class="bi bi-info-circle"></i>
                    Client Information
                </h6>
            </div>
            <div class="card-body">
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-number text-success">{{ clients|selectattr('status', 'equalto', 'active')|list|length }}</div>
                        <div class="info-label">Active Clients</div>
                    </div>
                    <div class="info-item">
                        <div class="info-number text-muted">{{ clients|selectattr('status', 'equalto', 'revoked')|list|length }}</div>
                        <div class="info-label">Revoked Clients</div>
                    </div>
                </div>
                <div class="mt-3">
                    <p class="text-muted mb-2">After adding a client:</p>
                    <ul class="list-unstyled">
                        <li><i class="bi bi-check-circle text-success me-2"></i>Configuration file (.ovpn) will be generated</li>
                        <li><i class="bi bi-check-circle text-success me-2"></i>Client can connect immediately</li>
                        <li><i class="bi bi-check-circle text-success me-2"></i>Download configuration from the table below</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions & Search -->
<div class="row mb-4">
    <!-- Search -->
    <div class="col-lg-8">
        <div class="search-container">
            <div class="search-box">
                <i class="bi bi-search search-icon"></i>
                <input type="text" id="clientSearch" class="form-control search-input" 
                       placeholder="🔍 Quick search clients by name, IP, or status..." 
                       onkeyup="searchClients()" autocomplete="off">
                <button class="btn btn-outline-secondary search-clear" onclick="clearSearch()" style="display: none;">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="search-stats" id="searchStats" style="display: none;">
                <small class="text-muted">Found <span id="searchCount">0</span> clients</small>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="col-lg-4">
        <div class="quick-actions">
            <div class="btn-group w-100" role="group">
                <button class="btn btn-outline-primary" onclick="exportClients()" title="Export Client List">
                    <i class="bi bi-download"></i>
                    <span class="d-none d-sm-inline">Export</span>
                </button>
                <button class="btn btn-outline-success" onclick="refreshAllData()" title="Refresh All Data">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span class="d-none d-sm-inline">Refresh</span>
                </button>
                <button class="btn btn-outline-warning" onclick="showBulkOperations()" title="Bulk Operations">
                    <i class="bi bi-check2-square"></i>
                    <span class="d-none d-sm-inline">Bulk</span>
                </button>
                <button class="btn btn-outline-info" onclick="showClientsInfo()" title="Clients Information">
                    <i class="bi bi-info-circle"></i>
                    <span class="d-none d-sm-inline">Info</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-funnel"></i>
                    Advanced Filters & Bulk Operations
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-3">
                        <label class="form-label">Filter by Group</label>
                        <select class="form-select" id="groupFilter" onchange="applyFilters()">
                            <option value="">All Groups</option>
                            <option value="admins">👑 Administrators</option>
                            <option value="users">👤 Regular Users</option>
                            <option value="guests">👥 Guests</option>
                            <option value="developers">💻 Developers</option>
                            <option value="managers">📊 Managers</option>
                            <option value="external">🌐 External Partners</option>
                            <option value="no_group">📋 No Group</option>
                        </select>
                    </div>
                    <div class="col-lg-3">
                        <label class="form-label">Filter by Status</label>
                        <select class="form-select" id="statusFilter" onchange="applyFilters()">
                            <option value="">All Status</option>
                            <option value="online">🟢 Online</option>
                            <option value="offline">⚫ Offline</option>
                            <option value="active">✅ Active</option>
                            <option value="revoked">❌ Revoked</option>
                            <option value="expiring">⚠️ Expiring Soon</option>
                        </select>
                    </div>
                    <div class="col-lg-3">
                        <label class="form-label">Filter by Profile</label>
                        <select class="form-select" id="profileFilter" onchange="applyFilters()">
                            <option value="">All Profiles</option>
                            <option value="standard">🔒 Standard</option>
                            <option value="high_bandwidth">🚀 High Bandwidth</option>
                            <option value="restricted">⏱️ Time Limited</option>
                            <option value="mobile_only">📱 Mobile Only</option>
                            <option value="admin_access">👑 Admin Access</option>
                            <option value="guest_limited">🎯 Guest Limited</option>
                        </select>
                    </div>
                    <div class="col-lg-3">
                        <label class="form-label">Bulk Operations</label>
                        <div class="d-grid">
                            <button class="btn btn-outline-warning" onclick="showBulkOperationsModal()">
                                <i class="bi bi-check2-square"></i> Select Multiple
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="filter-stats" id="filterStats" style="display: none;">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i>
                                Showing <span id="filteredCount">0</span> of <span id="totalCount">0</span> clients
                                <button class="btn btn-link btn-sm p-0 ms-2" onclick="clearFilters()">Clear Filters</button>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Client Management -->
{% set active_clients = clients|selectattr('status', 'equalto', 'active')|list %}
{% set revoked_clients = clients|selectattr('status', 'equalto', 'revoked')|list %}

<div class="card client-management-card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <div class="header-info">
                <h6 class="card-title mb-1">
                    <i class="bi bi-people"></i>
                    Active Clients
                </h6>
                <small class="text-muted">
                    <span id="activeClientsCount">{{ active_clients|length }}</span> active, 
                    <span id="connectedClientsCount">{{ active_clients|selectattr('is_online', 'equalto', true)|list|length if active_clients else 0 }}</span> connected
                </small>
            </div>
            <div class="header-controls d-flex gap-2">
                {% if revoked_clients %}
                <button class="btn btn-outline-secondary btn-sm" onclick="toggleRevokedClients()">
                    <i class="bi bi-eye" id="revokedToggleIcon"></i>
                    <span id="revokedToggleText">Show Revoked ({{ revoked_clients|length }})</span>
                </button>
                {% endif %}
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                    <label class="form-check-label" for="autoRefresh">Auto Refresh</label>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        {% if active_clients %}
            <div class="table-responsive">
                <table class="table" id="clientsTable">
                    <thead>
                        <tr>
                            <th>
                                <div class="th-content">
                                    <input type="checkbox" id="selectAllClients" onchange="toggleSelectAll()" style="margin-right: 8px;">
                                    <i class="bi bi-person"></i>
                                    Client
                                </div>
                            </th>
                            <th>
                                <div class="th-content">
                                    <i class="bi bi-wifi"></i>
                                    Status
                                </div>
                            </th>
                            <th>
                                <div class="th-content">
                                    <i class="bi bi-calendar-check"></i>
                                    Certificate Expiry
                                </div>
                            </th>
                            <th>
                                <div class="th-content">
                                    <i class="bi bi-arrow-left-right"></i>
                                    Data Transfer
                                </div>
                            </th>
                            <th>
                                <div class="th-content">
                                    <i class="bi bi-clock"></i>
                                    Activity
                                </div>
                            </th>
                            <th>
                                <div class="th-content">
                                    <i class="bi bi-file-earmark"></i>
                                    Config
                                </div>
                            </th>
                            <th>
                                <div class="th-content">
                                    <i class="bi bi-gear"></i>
                                    Actions
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for client in active_clients %}
                        <tr data-client="{{ client.name }}" class="animate-in" data-group="{{ client.group or 'no_group' }}" data-profile="{{ client.profile or 'standard' }}">
                            <td>
                                <div class="d-flex align-items-center">
                                    <input type="checkbox" class="client-checkbox me-2" value="{{ client.name }}" onchange="updateSelectedCount()">
                                    <div class="client-avatar">
                                        <i class="bi bi-person-circle"></i>
                                    </div>
                                    <div class="ms-2">
                                        <div class="d-flex align-items-center gap-2">
                                            <strong>{{ client.name }}</strong>
                                            {% if client.group %}
                                                <span class="badge bg-primary bg-opacity-75 client-group-badge">
                                                    <i class="bi bi-people"></i> {{ client.group }}
                                                </span>
                                            {% endif %}
                                            {% if client.profile and client.profile != 'standard' %}
                                                <span class="badge bg-info bg-opacity-75 client-profile-badge">
                                                    <i class="bi bi-person-badge"></i> {{ client.profile }}
                                                </span>
                                            {% endif %}
                                        </div>
                                        <div class="client-meta">
                                            <small class="text-muted">
                                                <i class="bi bi-calendar-plus me-1"></i>
                                                Created: {{ client.expiry_date or 'Unknown' }}
                                            </small>
                                            <div class="temporary-client-info" data-client="{{ client.name }}" style="display: none;">
                                                <small class="text-warning">
                                                    <i class="bi bi-alarm me-1"></i>
                                                    <span class="auto-revoke-text">Auto-revoke in: --</span>
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="connection-status">
                                {% if client.is_online %}
                                    <div class="status-badge status-online">
                                        <i class="bi bi-wifi"></i>Online
                                    </div>
                                    {% if client.current_connection %}
                                        <div class="mt-1">
                                            <small class="text-muted">{{ client.current_connection.real_address }}</small>
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <div class="status-badge status-offline">
                                        <i class="bi bi-wifi-off"></i>Offline
                                    </div>
                                {% endif %}
                            </td>
                            <td class="expiry-info">
                                {% if client.expiry_date %}
                                    <div class="certificate-status">
                                        {% if client.expiry_status == 'expired' %}
                                            <span class="badge badge-danger mb-1">
                                                <i class="bi bi-exclamation-triangle"></i> Expired
                                            </span>
                                            <div class="expiry-details">
                                                <small class="text-danger">{{ client.expiry_date }}</small>
                                            </div>
                                        {% elif client.expiry_status == 'expires_today' %}
                                            <span class="badge badge-danger mb-1">
                                                <i class="bi bi-alarm"></i> Expires Today
                                            </span>
                                            <div class="expiry-details">
                                                <small class="text-danger">{{ client.expiry_date }}</small>
                                                <small class="d-block text-danger"><strong>⚠️ Last day!</strong></small>
                                            </div>
                                        {% elif client.expiry_status == 'expiring_very_soon' %}
                                            <span class="badge badge-danger mb-1">
                                                <i class="bi bi-exclamation-triangle-fill"></i> Very Soon
                                            </span>
                                            <div class="expiry-details">
                                                <small class="text-danger">{{ client.expiry_date }}</small>
                                                <small class="d-block text-danger">{{ client.days_until_expiry }} days left</small>
                                            </div>
                                        {% elif client.expiry_status == 'expiring_soon' %}
                                            <span class="badge badge-warning mb-1">
                                                <i class="bi bi-clock"></i> Expires Soon
                                            </span>
                                            <div class="expiry-details">
                                                <small class="text-warning">{{ client.expiry_date }}</small>
                                                <small class="d-block">{{ client.days_until_expiry }} days left</small>
                                            </div>
                                        {% elif client.expiry_status == 'expiring_in_month' %}
                                            <span class="badge badge-warning mb-1">
                                                <i class="bi bi-calendar-week"></i> Expiring
                                            </span>
                                            <div class="expiry-details">
                                                <small class="text-warning">{{ client.expiry_date }}</small>
                                                <small class="d-block">{{ client.days_until_expiry }} days left</small>
                                            </div>
                                        {% elif client.expiry_status == 'expiring_in_3_months' %}
                                            <span class="badge badge-info mb-1">
                                                <i class="bi bi-info-circle"></i> Expiring
                                            </span>
                                            <div class="expiry-details">
                                                <small class="text-info">{{ client.expiry_date }}</small>
                                                <small class="d-block">{{ client.days_until_expiry }} days left</small>
                                            </div>
                                        {% else %}
                                            <span class="badge badge-success mb-1">
                                                <i class="bi bi-check-circle"></i> Valid
                                            </span>
                                            <div class="expiry-details">
                                                <small class="text-success">{{ client.expiry_date }}</small>
                                                {% if client.days_until_expiry %}
                                                    <small class="d-block">{{ client.days_until_expiry }} days left</small>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                        
                                        {% if client.expiry_status in ['expired', 'expires_today', 'expiring_very_soon', 'expiring_soon', 'expiring_in_month'] %}
                                            <button class="btn btn-outline-warning btn-xs mt-1" 
                                                    onclick="showRenewModal('{{ client.name }}')" 
                                                    title="Renew Certificate">
                                                <i class="bi bi-arrow-clockwise"></i> Renew
                                            </button>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <span class="badge badge-secondary">
                                        <i class="bi bi-question-circle"></i> Unknown
                                    </span>
                                {% endif %}
                            </td>
                            <td class="data-transfer-cell">
                                {% if client.is_online and client.current_connection %}
                                    <div class="transfer-stats">
                                        <div class="transfer-item">
                                            <span class="transfer-label">Sent:</span>
                                            <span class="transfer-value text-success">{{ (client.current_connection.bytes_sent | int / 1024 / 1024) | round(1) if client.current_connection.bytes_sent != 'N/A' else '0.0' }} MB</span>
                                        </div>
                                        <div class="transfer-item">
                                            <span class="transfer-label">Received:</span>
                                            <span class="transfer-value text-info">{{ (client.current_connection.bytes_received | int / 1024 / 1024) | round(1) if client.current_connection.bytes_received != 'N/A' else '0.0' }} MB</span>
                                        </div>
                                    </div>
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                            <td class="last-activity">
                                {% if client.is_online and client.current_connection %}
                                    <span class="activity-online">
                                        <i class="bi bi-circle-fill text-success"></i>
                                        Online: {{ client.current_connection.duration_formatted }}
                                    </span>
                                {% elif client.is_online %}
                                    <span class="activity-online">
                                        <i class="bi bi-circle-fill text-success"></i>
                                        Online now
                                    </span>
                                {% elif client.last_activity != 'Never' %}
                                    <small class="text-muted">{{ client.last_activity }}</small>
                                {% else %}
                                    <small class="text-muted">Never connected</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if client.has_config %}
                                    <span class="badge badge-success">
                                        <i class="bi bi-file-check"></i> Available
                                    </span>
                                {% else %}
                                    <span class="badge badge-warning">
                                        <i class="bi bi-file-x"></i> Missing
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="action-buttons">
                                    {% if client.has_config %}
                                        <a href="{{ url_for('download_config', client_name=client.name) }}" 
                                           class="btn btn-outline-primary btn-sm" title="Download Configuration">
                                            <i class="bi bi-download"></i>
                                        </a>
                                    {% endif %}
                                    
                                    <button type="button" class="btn btn-outline-danger btn-sm" 
                                            title="Revoke Client" 
                                            onclick="revokeClient('{{ client.name }}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Revoked Clients Table (Hidden by default) -->
            {% if revoked_clients %}
            <div id="revokedClientsSection" style="display: none;">
                <div class="revoked-header d-flex justify-content-between align-items-center">
                    <h6 class="text-muted mb-0">
                        <i class="bi bi-archive"></i>
                        Revoked Clients ({{ revoked_clients|length }})
                    </h6>
                    <div class="revoked-actions">
                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                onclick="confirmPermanentDeleteAll()" 
                                title="Permanently delete ALL revoked clients and their history">
                            <i class="bi bi-trash3"></i> Delete All Revoked
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Client Name</th>
                                <th>Revoked Date</th>
                                <th>Config Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for client in revoked_clients %}
                            <tr class="revoked-row">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-person-circle text-muted me-2"></i>
                                        <span class="text-muted">{{ client.name }}</span>
                                    </div>
                                </td>
                                <td>
                                    {% if client.revoke_date %}
                                        <div class="revoke-date">
                                            <i class="bi bi-calendar-x me-1"></i>
                                            <small class="text-muted">{{ client.revoke_date }}</small>
                                        </div>
                                    {% else %}
                                        <small class="text-muted">
                                            <i class="bi bi-question-circle me-1"></i>
                                            Unknown
                                        </small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if client.has_config %}
                                        <span class="badge badge-warning">
                                            <i class="bi bi-file-x"></i> Inactive
                                        </span>
                                    {% else %}
                                        <span class="badge badge-secondary">
                                            <i class="bi bi-file-x"></i> Removed
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-outline-success btn-sm" 
                                                title="Restore Client" 
                                                onclick="showRestoreModal('{{ client.name }}')">
                                            <i class="bi bi-arrow-clockwise"></i> Restore
                                        </button>
                                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                                title="Permanently delete this client and all history" 
                                                onclick="confirmPermanentDelete('{{ client.name }}')">
                                            <i class="bi bi-trash3"></i> Delete
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
            
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="bi bi-people"></i>
                </div>
                <h5>No Active Clients</h5>
                <p class="text-muted">Create your first VPN client using the form above</p>
                <a href="#client_name" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-1"></i>Add First Client
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Revoke Confirmation Modal -->
<div class="modal fade" id="revokeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>Confirm Revocation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Warning!</strong> This action cannot be undone.
                </div>
                <p>Are you sure you want to revoke access for client <strong id="clientNameToRevoke"></strong>?</p>
                <p class="text-muted">The client will immediately lose VPN access and will not be able to reconnect.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{{ url_for('revoke_client') }}" style="display: inline;">
                    <input type="hidden" name="client_name" id="clientNameInput">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i>Revoke Client
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Renew Certificate Modal -->
<div class="modal fade" id="renewModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-arrow-clockwise text-warning me-2"></i>Renew Certificate
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Note:</strong> This will create a new certificate for the client. The old certificate will be revoked.
                </div>
                <p>Renew certificate for client <strong id="clientNameToRenew"></strong></p>
                
                <form id="renewForm" method="POST" action="{{ url_for('renew_client') }}">
                    <input type="hidden" name="client_name" id="renewClientNameInput">
                    
                    <div class="mb-3">
                        <label for="renewExpiryDays" class="form-label">New Certificate Validity Period</label>
                        <select class="form-control" id="renewExpiryDays" name="expiry_days">
                            <option value="auto_1h">🕐 1 hour (Auto-revoke)</option>
                            <option value="auto_2h">🕑 2 hours (Auto-revoke)</option>
                            <option value="auto_6h">🕕 6 hours (Auto-revoke)</option>
                            <option value="auto_12h">🕛 12 hours (Auto-revoke)</option>
                            <option value="1">1 day (Quick Test)</option>
                            <option value="3">3 days (Short Test)</option>
                            <option value="7">1 week (Weekly Test)</option>
                            <option value="14">2 weeks (Bi-weekly Test)</option>
                            <option value="30">30 days (Trial)</option>
                            <option value="90">3 months</option>
                            <option value="180">6 months</option>
                            <option value="365" selected>1 year (Recommended)</option>
                            <option value="730">2 years</option>
                            <option value="1095">3 years</option>
                            <option value="3650">10 years (Legacy)</option>
                            <option value="custom">Custom...</option>
                        </select>
                        <div class="custom-days-input-renew mt-2" style="display: none;">
                            <input type="number" class="form-control" id="renewCustomDays" name="custom_days" 
                                   min="1" max="36500" placeholder="Enter days (1-36500)">
                        </div>
                        <div class="form-text">The client will need to download the new configuration file.</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="renewForm" class="btn btn-warning">
                    <i class="bi bi-arrow-clockwise me-1"></i>Renew Certificate
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Restore Client Modal -->
<div class="modal fade" id="restoreModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-arrow-clockwise text-success me-2"></i>Restore Client
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Restore Client:</strong> This will create a new certificate for the revoked client. They will get fresh access.
                </div>
                <p>Restore client <strong id="clientNameToRestore"></strong> with a new certificate?</p>
                
                <form id="restoreForm" method="POST" action="{{ url_for('restore_client') }}">
                    <input type="hidden" name="client_name" id="restoreClientNameInput">
                    
                    <div class="mb-3">
                        <label for="restoreExpiryDays" class="form-label">Certificate Validity Period</label>
                        <select class="form-control" id="restoreExpiryDays" name="expiry_days">
                            <option value="auto_1h">🕐 1 hour (Auto-revoke)</option>
                            <option value="auto_2h">🕑 2 hours (Auto-revoke)</option>
                            <option value="auto_6h">🕕 6 hours (Auto-revoke)</option>
                            <option value="auto_12h">🕛 12 hours (Auto-revoke)</option>
                            <option value="1">1 day (Quick Test)</option>
                            <option value="3">3 days (Short Test)</option>
                            <option value="7">1 week (Weekly Test)</option>
                            <option value="14">2 weeks (Bi-weekly Test)</option>
                            <option value="30">30 days (Trial)</option>
                            <option value="90">3 months</option>
                            <option value="180">6 months</option>
                            <option value="365" selected>1 year (Recommended)</option>
                            <option value="730">2 years</option>
                            <option value="1095">3 years</option>
                            <option value="3650">10 years (Legacy)</option>
                            <option value="custom">Custom...</option>
                        </select>
                        <div class="custom-days-input-restore mt-2" style="display: none;">
                            <input type="number" class="form-control" id="restoreCustomDays" name="custom_days" 
                                   min="1" max="36500" placeholder="Enter days (1-36500)">
                        </div>
                        <div class="form-text">Choose how long the restored client should have access.</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="restoreForm" class="btn btn-success">
                    <i class="bi bi-arrow-clockwise me-1"></i>Restore Client
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Permanent Delete Confirmation Modal -->
<div class="modal fade" id="permanentDeleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle text-danger me-2"></i>Permanently Delete Client
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>ВНИМАНИЕ!</strong> Это действие нельзя отменить!
                </div>
                <p>Вы уверены, что хотите <strong>навсегда удалить</strong> клиента <strong id="clientNameToPermanentDelete"></strong>?</p>
                <p class="text-muted">Это действие удалит:</p>
                <ul class="text-muted">
                    <li>Все сертификаты и ключи</li>
                    <li>Файлы конфигурации</li>
                    <li>Историю трафика</li>
                    <li>Записи из базы данных</li>
                    <li>Записи из index.txt</li>
                </ul>
                <p class="text-danger"><strong>Восстановление будет невозможно!</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" onclick="executePermanentDelete()">
                    <i class="bi bi-trash3 me-1"></i>Да, удалить навсегда
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Permanent Delete All Confirmation Modal -->
<div class="modal fade" id="permanentDeleteAllModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle text-danger me-2"></i>Удалить ВСЕ отозванные клиенты
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>КРИТИЧЕСКОЕ ПРЕДУПРЕЖДЕНИЕ!</strong> Это действие нельзя отменить!
                </div>
                <p>Вы собираетесь <strong>навсегда удалить ВСЕ {{ revoked_clients|length }} отозванных клиентов</strong> и всю их историю.</p>
                
                <div class="mb-3">
                    <p><strong>Будут удалены следующие клиенты:</strong></p>
                    <div class="border rounded p-2 bg-light" style="max-height: 150px; overflow-y: auto;">
                        {% for client in revoked_clients %}
                            <div class="d-flex justify-content-between py-1">
                                <span>{{ client.name }}</span>
                                <small class="text-muted">{{ client.revoke_date or 'Дата неизвестна' }}</small>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                
                <p class="text-muted">Для каждого клиента будет удалено:</p>
                <ul class="text-muted">
                    <li>Все сертификаты и ключи</li>
                    <li>Файлы конфигурации</li>
                    <li>Вся история трафика</li>
                    <li>Записи из базы данных</li>
                    <li>Записи из index.txt</li>
                </ul>
                
                <div class="alert alert-warning">
                    <p class="mb-2"><strong>Для подтверждения введите:</strong> <code>DELETE ALL</code></p>
                    <input type="text" id="confirmDeleteText" class="form-control" 
                           placeholder="Введите DELETE ALL" autocomplete="off">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteAllBtn" 
                        onclick="executePermanentDeleteAll()" disabled>
                    <i class="bi bi-trash3 me-1"></i>Да, удалить ВСЕ навсегда
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Client Templates Modal -->
<div class="modal fade" id="clientTemplatesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-file-earmark-text text-info me-2"></i>Client Templates
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="template-card" onclick="applyTemplate('admin')">
                            <div class="template-icon">👑</div>
                            <h6>Administrator</h6>
                            <p>Full access, no restrictions, admin group</p>
                            <ul class="template-features">
                                <li>✅ Admin group assignment</li>
                                <li>✅ Admin access profile</li>
                                <li>✅ 1 year validity</li>
                                <li>✅ High bandwidth</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="template-card" onclick="applyTemplate('regular_user')">
                            <div class="template-icon">👤</div>
                            <h6>Regular User</h6>
                            <p>Standard user with normal permissions</p>
                            <ul class="template-features">
                                <li>✅ Users group assignment</li>
                                <li>✅ Standard profile</li>
                                <li>✅ 1 year validity</li>
                                <li>✅ Normal bandwidth</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="template-card" onclick="applyTemplate('guest')">
                            <div class="template-icon">👥</div>
                            <h6>Guest Access</h6>
                            <p>Limited access for temporary users</p>
                            <ul class="template-features">
                                <li>✅ Guests group assignment</li>
                                <li>✅ Guest limited profile</li>
                                <li>✅ 30 days validity</li>
                                <li>⚠️ Limited bandwidth</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="template-card" onclick="applyTemplate('developer')">
                            <div class="template-icon">💻</div>
                            <h6>Developer</h6>
                            <p>Development environment access</p>
                            <ul class="template-features">
                                <li>✅ Developers group assignment</li>
                                <li>✅ High bandwidth profile</li>
                                <li>✅ 6 months validity</li>
                                <li>✅ Extended access</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="template-card" onclick="applyTemplate('external')">
                            <div class="template-icon">🌐</div>
                            <h6>External Partner</h6>
                            <p>External partner with restricted access</p>
                            <ul class="template-features">
                                <li>✅ External group assignment</li>
                                <li>✅ Restricted profile</li>
                                <li>✅ 3 months validity</li>
                                <li>⚠️ Time limited</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="template-card" onclick="applyTemplate('mobile')">
                            <div class="template-icon">📱</div>
                            <h6>Mobile Only</h6>
                            <p>Optimized for mobile devices</p>
                            <ul class="template-features">
                                <li>✅ Users group assignment</li>
                                <li>✅ Mobile only profile</li>
                                <li>✅ 1 year validity</li>
                                <li>⚠️ Mobile optimized</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Operations Modal -->
<div class="modal fade" id="bulkOperationsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-check2-square text-warning me-2"></i>Bulk Operations
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Selected Clients:</strong> <span id="selectedClientsCount">0</span> clients
                    <div id="selectedClientsList" class="mt-2"></div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>Group Operations</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" onclick="bulkAssignGroup()">
                                <i class="bi bi-people"></i> Assign to Group
                            </button>
                            <button class="btn btn-outline-secondary" onclick="bulkRemoveFromGroup()">
                                <i class="bi bi-person-x"></i> Remove from Group
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Certificate Operations</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-warning" onclick="bulkRenewCertificates()">
                                <i class="bi bi-arrow-clockwise"></i> Renew Certificates
                            </button>
                            <button class="btn btn-outline-danger" onclick="bulkRevokeClients()">
                                <i class="bi bi-trash"></i> Revoke Selected
                            </button>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>Profile Operations</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-info" onclick="bulkChangeProfile()">
                                <i class="bi bi-person-badge"></i> Change Profile
                            </button>
                            <button class="btn btn-outline-success" onclick="bulkDownloadConfigs()">
                                <i class="bi bi-download"></i> Download Configs
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Export Operations</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" onclick="bulkExportSelected()">
                                <i class="bi bi-file-earmark-spreadsheet"></i> Export Selected
                            </button>
                            <button class="btn btn-outline-info" onclick="bulkGenerateReport()">
                                <i class="bi bi-file-earmark-text"></i> Generate Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="selectAllVisible()">Select All Visible</button>
                <button type="button" class="btn btn-outline-secondary" onclick="clearSelection()">Clear Selection</button>
            </div>
        </div>
    </div>
</div>

<!-- Group Assignment Modal -->
<div class="modal fade" id="groupAssignModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-people text-primary me-2"></i>Assign to Group
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="bulkGroupSelect" class="form-label">Select Group</label>
                    <select class="form-select" id="bulkGroupSelect">
                        <option value="">No Group</option>
                        <option value="admins">👑 Administrators</option>
                        <option value="users">👤 Regular Users</option>
                        <option value="guests">👥 Guests</option>
                        <option value="developers">💻 Developers</option>
                        <option value="managers">📊 Managers</option>
                        <option value="external">🌐 External Partners</option>
                    </select>
                </div>
                <div id="bulkSelectedClients" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmBulkGroupAssign()">
                    <i class="bi bi-check"></i> Assign Group
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let autoRefreshEnabled = true;
let updateInterval;

function revokeClient(clientName) {
    document.getElementById('clientNameToRevoke').textContent = clientName;
    document.getElementById('clientNameInput').value = clientName;
    new bootstrap.Modal(document.getElementById('revokeModal')).show();
}

function enableMonitoring() {
    if (confirm('This will enable enhanced monitoring and restart the OpenVPN service. Continue?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/enable_monitoring';
        document.body.appendChild(form);
        form.submit();
    }
}

function toggleRevokedClients() {
    const section = document.getElementById('revokedClientsSection');
    const icon = document.getElementById('revokedToggleIcon');
    const text = document.getElementById('revokedToggleText');
    
    if (section.style.display === 'none') {
        section.style.display = 'block';
        icon.className = 'bi bi-eye-slash';
        text.textContent = 'Hide Revoked';
        section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    } else {
        section.style.display = 'none';
        icon.className = 'bi bi-eye';
        text.textContent = text.textContent.replace('Hide', 'Show');
    }
}

function updateClientTable(activeConnections) {
    const clientsTable = document.getElementById('clientsTable');
    if (!clientsTable) return;
    
    const rows = clientsTable.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        const clientName = row.getAttribute('data-client');
        const connectionStatus = row.querySelector('.connection-status');
        const dataTransferCell = row.querySelector('.data-transfer-cell');
        const lastActivityCell = row.querySelector('.last-activity');
        
        // Find active connection for this client
        const activeConn = activeConnections.find(conn => conn.name === clientName);
        
        if (activeConn) {
            // Client is online
            connectionStatus.innerHTML = `
                <div class="status-badge status-online">
                    <i class="bi bi-wifi"></i>Online
                </div>
                <div class="mt-1">
                    <small class="text-muted">${activeConn.real_address}</small>
                </div>
            `;
            
            const sentMB = activeConn.bytes_sent !== 'N/A' && activeConn.bytes_sent !== '0' ? 
                (parseInt(activeConn.bytes_sent) / 1024 / 1024).toFixed(1) : '0.0';
            const receivedMB = activeConn.bytes_received !== 'N/A' && activeConn.bytes_received !== '0' ? 
                (parseInt(activeConn.bytes_received) / 1024 / 1024).toFixed(1) : '0.0';
            
            dataTransferCell.innerHTML = `
                <div class="transfer-stats">
                    <div class="transfer-item">
                        <span class="transfer-label">Sent:</span>
                        <span class="transfer-value text-success">${sentMB} MB</span>
                    </div>
                    <div class="transfer-item">
                        <span class="transfer-label">Received:</span>
                        <span class="transfer-value text-info">${receivedMB} MB</span>
                    </div>
                </div>
            `;
            
            const durationFormatted = activeConn.duration_formatted || 'N/A';
            
            lastActivityCell.innerHTML = `
                <span class="activity-online">
                    <i class="bi bi-circle-fill text-success"></i>
                    Online: ${durationFormatted}
                </span>
            `;
        } else {
            // Client is offline
            connectionStatus.innerHTML = `
                <div class="status-badge status-offline">
                    <i class="bi bi-wifi-off"></i>Offline
                </div>
            `;
            
            dataTransferCell.innerHTML = `<span class="text-muted">—</span>`;
            
            // Keep the original last activity if it exists
            if (!lastActivityCell.querySelector('span')?.textContent?.includes('Never connected')) {
                lastActivityCell.innerHTML = `<small class="text-muted">Recently disconnected</small>`;
            }
        }
    });
}

function updateClientsData() {
    if (!autoRefreshEnabled) return;
    
    fetch('/api/activity')
        .then(response => response.json())
        .then(data => {
            updateClientTable(data.active_connections);
            updateTemporaryClientsInfo();
        })
        .catch(error => console.error('Error updating clients data:', error));
}

function updateTemporaryClientsInfo() {
    fetch('/api/temporary_clients')
        .then(response => response.json())
        .then(data => {
            // Hide all temporary client info first
            document.querySelectorAll('.temporary-client-info').forEach(info => {
                info.style.display = 'none';
            });
            
            // Update temporary clients
            Object.keys(data).forEach(clientName => {
                const tempInfo = data[clientName];
                const infoDiv = document.querySelector(`.temporary-client-info[data-client="${clientName}"]`);
                
                if (infoDiv && tempInfo.is_temporary) {
                    const textSpan = infoDiv.querySelector('.auto-revoke-text');
                    if (textSpan) {
                        textSpan.textContent = `Auto-revoke in: ${tempInfo.time_left_str}`;
                        infoDiv.style.display = 'block';
                        
                        // Add warning color if less than 1 hour left
                        if (tempInfo.hours_left < 1) {
                            infoDiv.innerHTML = `<small class="text-danger">
                                <i class="bi bi-exclamation-triangle me-1"></i>
                                <span class="auto-revoke-text">Auto-revoke in: ${tempInfo.time_left_str}</span>
                            </small>`;
                        } else {
                            infoDiv.innerHTML = `<small class="text-warning">
                                <i class="bi bi-alarm me-1"></i>
                                <span class="auto-revoke-text">Auto-revoke in: ${tempInfo.time_left_str}</span>
                            </small>`;
                        }
                    }
                }
            });
        })
        .catch(error => console.error('Error updating temporary clients:', error));
}

// Auto-refresh toggle
document.getElementById('autoRefresh')?.addEventListener('change', function() {
    autoRefreshEnabled = this.checked;
    if (autoRefreshEnabled) {
        updateClientsData();
    }
});

function searchClients() {
    const searchTerm = document.getElementById('clientSearch').value.toLowerCase().trim();
    const clientRows = document.querySelectorAll('#clientsTable tbody tr[data-client]');
    const revokedRows = document.querySelectorAll('#revokedClientsSection tbody tr');
    const clearButton = document.querySelector('.search-clear');
    const searchStats = document.getElementById('searchStats');
    const searchCount = document.getElementById('searchCount');
    
    let visibleCount = 0;
    
    // Show/hide clear button
    clearButton.style.display = searchTerm ? 'block' : 'none';
    
    // Search in active clients
    clientRows.forEach(row => {
        const clientName = row.getAttribute('data-client').toLowerCase();
        const clientText = row.textContent.toLowerCase();
        
        if (searchTerm === '' || clientName.includes(searchTerm) || clientText.includes(searchTerm)) {
            row.style.display = '';
            row.classList.remove('search-hidden');
            visibleCount++;
            
            // Highlight matching text
            if (searchTerm) {
                highlightSearchTerm(row, searchTerm);
            } else {
                removeHighlight(row);
            }
        } else {
            row.style.display = 'none';
            row.classList.add('search-hidden');
        }
    });
    
    // Search in revoked clients if visible
    const revokedSection = document.getElementById('revokedClientsSection');
    if (revokedSection && revokedSection.style.display !== 'none') {
        revokedRows.forEach(row => {
            const clientText = row.textContent.toLowerCase();
            
            if (searchTerm === '' || clientText.includes(searchTerm)) {
                row.style.display = '';
                visibleCount++;
                
                if (searchTerm) {
                    highlightSearchTerm(row, searchTerm);
                } else {
                    removeHighlight(row);
                }
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    // Update search stats
    if (searchTerm) {
        searchStats.style.display = 'block';
        searchCount.textContent = visibleCount;
    } else {
        searchStats.style.display = 'none';
    }
    
    // Show empty state if no results
    updateEmptyState(visibleCount, searchTerm);
}

function highlightSearchTerm(row, searchTerm) {
    const cells = row.querySelectorAll('td');
    cells.forEach(cell => {
        if (!cell.querySelector('.btn')) { // Skip action buttons
            const originalText = cell.textContent;
            const regex = new RegExp(`(${escapeRegex(searchTerm)})`, 'gi');
            const highlightedHTML = originalText.replace(regex, '<mark class="search-highlight">$1</mark>');
            
            // Only update if there's a match
            if (highlightedHTML !== originalText) {
                cell.innerHTML = highlightedHTML;
            }
        }
    });
}

function removeHighlight(row) {
    const marks = row.querySelectorAll('mark.search-highlight');
    marks.forEach(mark => {
        mark.outerHTML = mark.textContent;
    });
}

function escapeRegex(text) {
    return text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function clearSearch() {
    document.getElementById('clientSearch').value = '';
    searchClients();
    document.getElementById('clientSearch').focus();
}

function updateEmptyState(visibleCount, searchTerm) {
    const tableBody = document.querySelector('#clientsTable tbody');
    let emptyMessage = tableBody.querySelector('.search-empty-state');
    
    if (visibleCount === 0 && searchTerm) {
        if (!emptyMessage) {
            emptyMessage = document.createElement('tr');
            emptyMessage.className = 'search-empty-state';
            emptyMessage.innerHTML = `
                <td colspan="6" class="text-center py-4">
                    <div class="empty-search-state">
                        <i class="bi bi-search text-muted" style="font-size: 2rem;"></i>
                        <p class="mt-2 mb-0">No clients found matching "<strong>${searchTerm}</strong>"</p>
                        <button class="btn btn-link btn-sm" onclick="clearSearch()">Clear search</button>
                    </div>
                </td>
            `;
            tableBody.appendChild(emptyMessage);
        }
    } else if (emptyMessage) {
        emptyMessage.remove();
    }
}

// Add styles for clients page
const style = document.createElement('style');
style.textContent = `
    .search-container {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        margin-bottom: 1rem;
    }
    
    .search-box {
        position: relative;
        display: flex;
        align-items: center;
    }
    
    .search-icon {
        position: absolute;
        left: 1rem;
        color: #64748b;
        z-index: 3;
        font-size: 1.1rem;
    }
    
    .search-input {
        padding-left: 3rem;
        padding-right: 3rem;
        height: 50px;
        border: 2px solid #e2e8f0;
        border-radius: 25px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: white;
    }
    
    .search-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        transform: translateY(-1px);
    }
    
    .search-clear {
        position: absolute;
        right: 8px;
        border: none;
        background: transparent;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        z-index: 3;
    }
    
    .search-stats {
        margin-top: 0.75rem;
        text-align: center;
    }
    
    .search-highlight {
        background: #fef08a;
        padding: 0.1rem 0.2rem;
        border-radius: 3px;
        font-weight: 600;
    }
    
    .client-management-card {
        border: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        border-radius: 12px;
        overflow: hidden;
    }
    
    .client-management-card .card-header {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-bottom: 1px solid #e2e8f0;
        padding: 1.5rem;
    }
    
    .header-info .card-title {
        color: #1e293b;
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    .header-controls {
        align-items: center;
    }
    
    .animate-in {
        animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .client-avatar {
        font-size: 1.5rem;
        color: #3b82f6;
    }
    
    .client-meta {
        margin-top: 0.25rem;
    }
    
    .transfer-stats {
        font-size: 0.85rem;
        padding: 0.3rem 0.6rem;
        background: #f8fafc;
        border-radius: 6px;
        border: 1px solid #f1f5f9;
        line-height: 1.1;
    }
    
    .transfer-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0;
        line-height: 1.1;
    }
    
    .transfer-label {
        color: #64748b;
        font-weight: 500;
        font-size: 0.8rem;
    }
    
    .transfer-value {
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .activity-online {
        color: #10b981;
        font-weight: 500;
        font-size: 0.85rem;
    }
    
    .action-buttons {
        display: flex;
        gap: 0.25rem;
    }
    
    .revoked-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e2e8f0;
        background: #f8fafc;
    }
    
    .revoked-row {
        opacity: 0.7;
    }
    
    .revoke-date {
        display: flex;
        align-items: center;
        font-size: 0.85rem;
    }
    
    .revoke-date i {
        color: #ef4444;
        font-size: 0.8rem;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem 2rem;
    }
    
    .empty-icon {
        font-size: 4rem;
        color: #cbd5e1;
        margin-bottom: 1rem;
    }
    
    .empty-search-state {
        color: #64748b;
        padding: 2rem;
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }
    
    .info-item {
        text-align: center;
        padding: 1rem;
        background: #f8fafc;
        border-radius: 8px;
        transition: all 0.2s ease;
    }
    
    .info-item:hover {
        background: #e2e8f0;
        transform: translateY(-1px);
    }
    
    .info-number {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
    }
    
    .info-label {
        font-size: 0.8rem;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .badge-success {
        background: #dcfce7;
        color: #166534;
    }
    
    .badge-warning {
        background: #fef3c7;
        color: #92400e;
    }
    
    .badge-secondary {
        background: #f1f5f9;
        color: #475569;
    }
    
    /* Enhanced table styling */
    .table {
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .table thead th {
        background: #f8fafc;
        border-bottom: 2px solid #e2e8f0;
        color: #374151;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        padding: 1rem;
    }
    
    .table tbody tr {
        transition: all 0.2s ease;
    }
    
    .table tbody tr:hover {
        background: #f8fafc;
        transform: translateX(4px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .table tbody td {
        padding: 1rem;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: middle;
    }
    
    /* Status badges enhancement */
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    .status-online {
        background: #dcfce7;
        color: #166534;
        border: 1px solid #bbf7d0;
    }
    
    .status-offline {
        background: #f1f5f9;
        color: #64748b;
        border: 1px solid #e2e8f0;
    }
    
    /* Quick Actions */
    .quick-actions {
        margin-bottom: 1rem;
    }
    
    .quick-actions .btn-group {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        overflow: hidden;
    }
    
    .quick-actions .btn {
        border: none;
        padding: 0.75rem 1rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .quick-actions .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    /* Enhanced table headers */
    .th-content {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        color: #374151;
    }
    
    .th-content i {
        font-size: 0.9rem;
        opacity: 0.7;
    }
    
    /* Custom notifications */
    .custom-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1060;
        min-width: 300px;
        max-width: 400px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        animation: slideInRight 0.3s ease-out;
    }
    
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    /* Clients info modal */
    .clients-info-modal {
        text-align: center;
    }
    
    .info-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
        margin: 1.5rem 0;
    }
    
    .stat-item {
        padding: 1rem;
        background: #f8fafc;
        border-radius: 8px;
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }
    
    .stat-item:hover {
        border-color: #e2e8f0;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .stat-description {
        font-size: 0.9rem;
        color: #64748b;
        font-weight: 500;
    }
    
    /* Additional badge styles */
    .badge-danger {
        background-color: #ef4444;
        color: white;
    }
    
    .badge-info {
        background-color: #3b82f6;
        color: white;
    }
    
    .badge-warning {
        background-color: #f59e0b;
        color: white;
    }
    
    .badge-success {
        background-color: #10b981;
        color: white;
    }
    
    .badge-secondary {
        background-color: #6b7280;
        color: white;
    }
    
    /* Extra small button */
    .btn-xs {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        line-height: 1.2;
        border-radius: 0.2rem;
    }
    
    /* Certificate expiry status styling */
    .expiry-info {
        min-width: 140px;
    }
    
    .certificate-status {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
    }
    
    .expiry-details {
        font-size: 0.8rem;
        line-height: 1.2;
    }
    
    .expiry-details small {
        display: block;
    }
    
    /* Custom input styles */
    .custom-days-input,
    .custom-days-input-renew {
        animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            max-height: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            max-height: 100px;
            transform: translateY(0);
        }
    }
    
    /* Form enhancements */
    .form-control:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
    }
    
    /* Modal enhancements */
    .modal-header {
        border-bottom: 1px solid #e2e8f0;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }
    
    .modal-title {
        font-weight: 600;
    }
    
    .alert-info {
        border-color: #bfdbfe;
        background-color: #eff6ff;
        color: #1e40af;
    }
    
    .alert-warning {
        border-color: #fed7aa;
        background-color: #fffbeb;
        color: #92400e;
    }
`;
document.head.appendChild(style);

// Initialize temporary clients info on page load
document.addEventListener('DOMContentLoaded', function() {
    updateTemporaryClientsInfo();
    
    // Update temporary clients info every 30 seconds
    setInterval(updateTemporaryClientsInfo, 30000);
});

// Start auto-refresh if enabled
document.addEventListener('DOMContentLoaded', function() {
    updateClientsData();
    updateInterval = setInterval(updateClientsData, 15000);
});

window.addEventListener('beforeunload', function() {
    if (updateInterval) {
        clearInterval(updateInterval);
    }
});

function showRenewModal(clientName) {
    document.getElementById('clientNameToRenew').textContent = clientName;
    document.getElementById('renewClientNameInput').value = clientName;
    new bootstrap.Modal(document.getElementById('renewModal')).show();
}

function showRestoreModal(clientName) {
    document.getElementById('clientNameToRestore').textContent = clientName;
    document.getElementById('restoreClientNameInput').value = clientName;
    new bootstrap.Modal(document.getElementById('restoreModal')).show();
}

// Handle custom expiry days input for add client form
document.getElementById('expiry_days')?.addEventListener('change', function() {
    const customInput = document.querySelector('.custom-days-input');
    const customDaysField = document.getElementById('custom_days');
    
    if (this.value === 'custom') {
        customInput.style.display = 'block';
        customDaysField.required = true;
        customDaysField.focus();
    } else {
        customInput.style.display = 'none';
        customDaysField.required = false;
        customDaysField.value = '';
    }
});

// Handle form submission for custom days
document.querySelector('form[action*="add_client"]')?.addEventListener('submit', function(e) {
    const expirySelect = document.getElementById('expiry_days');
    const customDaysField = document.getElementById('custom_days');
    
    if (expirySelect.value === 'custom') {
        const customDays = parseInt(customDaysField.value);
        if (!customDays || customDays < 1 || customDays > 36500) {
            e.preventDefault();
            alert('Please enter a valid number of days (1-36500)');
            customDaysField.focus();
            return false;
        }
        // Set the value to the select
        expirySelect.value = customDays;
    }
});

// Handle custom expiry days input for renew modal
document.getElementById('renewExpiryDays')?.addEventListener('change', function() {
    const customInput = document.querySelector('.custom-days-input-renew');
    const customDaysField = document.getElementById('renewCustomDays');
    
    if (this.value === 'custom') {
        customInput.style.display = 'block';
        customDaysField.required = true;
        customDaysField.focus();
    } else {
        customInput.style.display = 'none';
        customDaysField.required = false;
        customDaysField.value = '';
    }
});

// Handle renew form submission for custom days
document.getElementById('renewForm')?.addEventListener('submit', function(e) {
    const expirySelect = document.getElementById('renewExpiryDays');
    const customDaysField = document.getElementById('renewCustomDays');
    
    if (expirySelect.value === 'custom') {
        const customDays = parseInt(customDaysField.value);
        if (!customDays || customDays < 1 || customDays > 36500) {
            e.preventDefault();
            alert('Please enter a valid number of days (1-36500)');
            customDaysField.focus();
            return false;
        }
        // Set the value to the expiry_days field
        expirySelect.value = customDays;
    }
});

// Handle custom expiry days input for restore modal
document.getElementById('restoreExpiryDays')?.addEventListener('change', function() {
    const customInput = document.querySelector('.custom-days-input-restore');
    const customDaysField = document.getElementById('restoreCustomDays');
    
    if (this.value === 'custom') {
        customInput.style.display = 'block';
        customDaysField.required = true;
        customDaysField.focus();
    } else {
        customInput.style.display = 'none';
        customDaysField.required = false;
        customDaysField.value = '';
    }
});

// Handle restore form submission for custom days
document.getElementById('restoreForm')?.addEventListener('submit', function(e) {
    const expirySelect = document.getElementById('restoreExpiryDays');
    const customDaysField = document.getElementById('restoreCustomDays');
    
    if (expirySelect.value === 'custom') {
        const customDays = parseInt(customDaysField.value);
        if (!customDays || customDays < 1 || customDays > 36500) {
            e.preventDefault();
            alert('Please enter a valid number of days (1-36500)');
            customDaysField.focus();
            return false;
        }
        // Set the value to the expiry_days field
        expirySelect.value = customDays;
    }
});

function toggleRevokedClients() {
    const section = document.getElementById('revokedClientsSection');
    const icon = document.getElementById('revokedToggleIcon');
    const text = document.getElementById('revokedToggleText');
    
    if (section.style.display === 'none') {
        section.style.display = 'block';
        icon.className = 'bi bi-eye-slash';
        text.textContent = 'Hide Revoked';
        section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    } else {
        section.style.display = 'none';
        icon.className = 'bi bi-eye';
        text.textContent = text.textContent.replace('Hide', 'Show');
    }
}

// Permanent deletion functions
let clientToDelete = null;

function confirmPermanentDelete(clientName) {
    clientToDelete = clientName;
    document.getElementById('clientNameToPermanentDelete').textContent = clientName;
    new bootstrap.Modal(document.getElementById('permanentDeleteModal')).show();
}

function executePermanentDelete() {
    if (!clientToDelete) return;
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('permanentDeleteModal'));
    modal.hide();
    
    showProgress('Удаление клиента ' + clientToDelete + '...');
    
    fetch('/api/permanently_delete_client', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            client_name: clientToDelete
        })
    })
    .then(response => response.json())
    .then(data => {
        hideProgress();
        
        if (data.success) {
            showNotification('Клиент ' + clientToDelete + ' навсегда удален!', 'success');
            // Reload the page to update the client list
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showNotification('Ошибка: ' + data.error, 'error');
        }
    })
    .catch(error => {
        hideProgress();
        console.error('Error:', error);
        showNotification('Ошибка соединения', 'error');
    });
    
    clientToDelete = null;
}

function confirmPermanentDeleteAll() {
    new bootstrap.Modal(document.getElementById('permanentDeleteAllModal')).show();
    
    // Enable/disable button based on confirmation text
    const confirmInput = document.getElementById('confirmDeleteText');
    const confirmBtn = document.getElementById('confirmDeleteAllBtn');
    
    confirmInput.addEventListener('input', function() {
        if (this.value === 'DELETE ALL') {
            confirmBtn.disabled = false;
            confirmBtn.classList.remove('btn-secondary');
            confirmBtn.classList.add('btn-danger');
        } else {
            confirmBtn.disabled = true;
            confirmBtn.classList.add('btn-secondary');
            confirmBtn.classList.remove('btn-danger');
        }
    });
    
    // Clear the input when modal is shown
    confirmInput.value = '';
    confirmBtn.disabled = true;
}

function executePermanentDeleteAll() {
    const confirmInput = document.getElementById('confirmDeleteText');
    if (confirmInput.value !== 'DELETE ALL') {
        showNotification('Неправильный текст подтверждения', 'error');
        return;
    }
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('permanentDeleteAllModal'));
    modal.hide();
    
    showProgress('Удаление всех отозванных клиентов...');
    
    fetch('/api/permanently_delete_revoked', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        hideProgress();
        
        if (data.success) {
            showNotification('Все отозванные клиенты навсегда удалены!', 'success');
            // Reload the page to update the client list
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showNotification('Ошибка: ' + data.error, 'error');
        }
    })
    .catch(error => {
        hideProgress();
        console.error('Error:', error);
        showNotification('Ошибка соединения', 'error');
    });
}

function showProgress(message) {
    // Create progress overlay
    const overlay = document.createElement('div');
    overlay.id = 'progressOverlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    `;
    
    const progressBox = document.createElement('div');
    progressBox.style.cssText = `
        background: white;
        padding: 2rem;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    `;
    
    progressBox.innerHTML = `
        <div class="spinner-border text-danger mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mb-0 text-muted">${message}</p>
    `;
    
    overlay.appendChild(progressBox);
    document.body.appendChild(overlay);
}

function hideProgress() {
    const overlay = document.getElementById('progressOverlay');
    if (overlay) {
        overlay.remove();
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} custom-notification`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1060;
        min-width: 300px;
        max-width: 400px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        animation: slideInRight 0.3s ease-out;
    `;
    
    const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle';
    
    notification.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="bi bi-${icon} me-2"></i>
            <span class="flex-grow-1">${message}</span>
            <button type="button" class="btn-close btn-close-white ms-2" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}

// Enhanced Client Management Functions
let selectedClients = [];

// Handle custom group selection for add client form
document.getElementById('client_group')?.addEventListener('change', function() {
    const customInput = document.querySelector('.custom-group-input');
    const customGroupField = document.getElementById('custom_group_name');
    
    if (this.value === 'custom') {
        customInput.style.display = 'block';
        customGroupField.required = true;
        customGroupField.focus();
    } else {
        customInput.style.display = 'none';
        customGroupField.required = false;
        customGroupField.value = '';
    }
});

// Client Templates Functions
function showClientTemplates() {
    new bootstrap.Modal(document.getElementById('clientTemplatesModal')).show();
}

function applyTemplate(templateType) {
    const templates = {
        admin: {
            group: 'admins',
            profile: 'admin_access',
            expiry: '365'
        },
        regular_user: {
            group: 'users',
            profile: 'standard',
            expiry: '365'
        },
        guest: {
            group: 'guests',
            profile: 'guest_limited',
            expiry: '30'
        },
        developer: {
            group: 'developers',
            profile: 'high_bandwidth',
            expiry: '180'
        },
        external: {
            group: 'external',
            profile: 'restricted',
            expiry: '90'
        },
        mobile: {
            group: 'users',
            profile: 'mobile_only',
            expiry: '365'
        }
    };
    
    const template = templates[templateType];
    if (template) {
        document.getElementById('client_group').value = template.group;
        document.getElementById('client_profile').value = template.profile;
        document.getElementById('expiry_days').value = template.expiry;
        
        // Hide templates modal
        bootstrap.Modal.getInstance(document.getElementById('clientTemplatesModal')).hide();
        
        // Focus on client name input
        document.getElementById('client_name').focus();
        
        showNotification(`Template "${templateType.replace('_', ' ')}" applied successfully!`, 'success');
    }
}

// Bulk Operations Functions
function showBulkOperationsModal() {
    selectedClients = Array.from(document.querySelectorAll('.client-checkbox:checked')).map(cb => cb.value);
    
    if (selectedClients.length === 0) {
        showNotification('Please select clients first', 'warning');
        return;
    }
    
    updateBulkOperationsModal();
    new bootstrap.Modal(document.getElementById('bulkOperationsModal')).show();
}

function updateBulkOperationsModal() {
    document.getElementById('selectedClientsCount').textContent = selectedClients.length;
    
    const clientsList = document.getElementById('selectedClientsList');
    clientsList.innerHTML = selectedClients.map(name => 
        `<span class="badge bg-primary me-1 mb-1">${name}</span>`
    ).join('');
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAllClients');
    const checkboxes = document.querySelectorAll('.client-checkbox');
    
    checkboxes.forEach(cb => {
        cb.checked = selectAll.checked;
    });
    
    updateSelectedCount();
}

function updateSelectedCount() {
    selectedClients = Array.from(document.querySelectorAll('.client-checkbox:checked')).map(cb => cb.value);
    
    // Update select all checkbox state
    const selectAll = document.getElementById('selectAllClients');
    const checkboxes = document.querySelectorAll('.client-checkbox');
    const checkedCount = document.querySelectorAll('.client-checkbox:checked').length;
    
    if (checkedCount === 0) {
        selectAll.indeterminate = false;
        selectAll.checked = false;
    } else if (checkedCount === checkboxes.length) {
        selectAll.indeterminate = false;
        selectAll.checked = true;
    } else {
        selectAll.indeterminate = true;
    }
}

function selectAllVisible() {
    const visibleCheckboxes = document.querySelectorAll('.client-checkbox:not([style*="display: none"])');
    visibleCheckboxes.forEach(cb => cb.checked = true);
    updateSelectedCount();
    updateBulkOperationsModal();
}

function clearSelection() {
    document.querySelectorAll('.client-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('selectAllClients').checked = false;
    document.getElementById('selectAllClients').indeterminate = false;
    selectedClients = [];
    updateBulkOperationsModal();
}

// Advanced Filtering Functions
function applyFilters() {
    const groupFilter = document.getElementById('groupFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const profileFilter = document.getElementById('profileFilter').value;
    
    const rows = document.querySelectorAll('#clientsTable tbody tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        let visible = true;
        
        // Group filter
        if (groupFilter && row.dataset.group !== groupFilter) {
            visible = false;
        }
        
        // Status filter
        if (statusFilter && visible) {
            const isOnline = row.querySelector('.status-online') !== null;
            const isRevoked = row.querySelector('.status-revoked') !== null;
            
            switch (statusFilter) {
                case 'online':
                    visible = isOnline;
                    break;
                case 'offline':
                    visible = !isOnline && !isRevoked;
                    break;
                case 'active':
                    visible = !isRevoked;
                    break;
                case 'revoked':
                    visible = isRevoked;
                    break;
                case 'expiring':
                    // Check if certificate expires within 30 days
                    const expiryText = row.querySelector('.expiry-info')?.textContent || '';
                    visible = expiryText.includes('days') && parseInt(expiryText) < 30;
                    break;
            }
        }
        
        // Profile filter
        if (profileFilter && visible && row.dataset.profile !== profileFilter) {
            visible = false;
        }
        
        row.style.display = visible ? '' : 'none';
        if (visible) visibleCount++;
    });
    
    // Update filter stats
    const filterStats = document.getElementById('filterStats');
    const totalCount = rows.length;
    
    if (groupFilter || statusFilter || profileFilter) {
        filterStats.style.display = 'block';
        document.getElementById('filteredCount').textContent = visibleCount;
        document.getElementById('totalCount').textContent = totalCount;
    } else {
        filterStats.style.display = 'none';
    }
}

function clearFilters() {
    document.getElementById('groupFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('profileFilter').value = '';
    applyFilters();
}

// Bulk Group Assignment
function bulkAssignGroup() {
    if (selectedClients.length === 0) {
        showNotification('No clients selected', 'warning');
        return;
    }
    
    document.getElementById('bulkSelectedClients').innerHTML = selectedClients.map(name => 
        `<span class="badge bg-secondary me-1">${name}</span>`
    ).join('');
    
    bootstrap.Modal.getInstance(document.getElementById('bulkOperationsModal')).hide();
    new bootstrap.Modal(document.getElementById('groupAssignModal')).show();
}

function confirmBulkGroupAssign() {
    const selectedGroup = document.getElementById('bulkGroupSelect').value;
    
    if (selectedClients.length === 0) {
        showNotification('No clients selected', 'warning');
        return;
    }
    
    showProgress(`Assigning ${selectedClients.length} clients to group...`);
    
    fetch('/api/bulk_assign_group', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            clients: selectedClients,
            group: selectedGroup
        })
    })
    .then(response => response.json())
    .then(data => {
        hideProgress();
        bootstrap.Modal.getInstance(document.getElementById('groupAssignModal')).hide();
        
        if (data.success) {
            showNotification(`Successfully assigned ${selectedClients.length} clients to group!`, 'success');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showNotification('Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        hideProgress();
        showNotification('Connection error: ' + error.message, 'error');
    });
}

// Export Functions
function exportClients() {
    showProgress('Exporting client list...');
    
    fetch('/api/export_clients')
    .then(response => response.blob())
    .then(blob => {
        hideProgress();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `openvpn-clients-${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        showNotification('Client list exported successfully!', 'success');
    })
    .catch(error => {
        hideProgress();
        showNotification('Export failed: ' + error.message, 'error');
    });
}

// ======================== MISSING FUNCTIONS ========================

// Function called by "Bulk Operations" button
function showBulkOperations() {
    showBulkOperationsModal();
}

// Function called by "Client Info" button  
function showClientsInfo() {
    fetch('/api/client_statistics')
    .then(response => response.json())
    .then(data => {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-info-circle text-info me-2"></i>Client Statistics
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="stat-card text-center">
                                    <div class="stat-value text-primary">${data.total_clients || 0}</div>
                                    <div class="stat-label">Total Clients</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stat-card text-center">
                                    <div class="stat-value text-success">${data.online_clients || 0}</div>
                                    <div class="stat-label">Online Now</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stat-card text-center">
                                    <div class="stat-value text-warning">${data.active_clients || 0}</div>
                                    <div class="stat-label">Active Clients</div>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <h6>Group Distribution:</h6>
                        <div id="groupStats"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();
        
        // Clean up modal when hidden
        modal.addEventListener('hidden.bs.modal', () => {
            document.body.removeChild(modal);
        });
    })
    .catch(error => {
        console.error('Error loading client statistics:', error);
        showNotification('Error loading client statistics', 'error');
    });
}

// Function called by "Refresh" button
function refreshAllData() {
    showNotification('Refreshing all data...', 'info');
    
    // Clear any existing auto-refresh
    if (updateInterval) {
        clearInterval(updateInterval);
    }
    
    // Force immediate update
    updateClientsData();
    updateTemporaryClientsInfo();
    
    // Restart auto-refresh if enabled
    if (autoRefreshEnabled) {
        updateInterval = setInterval(() => {
            updateClientsData();
            updateTemporaryClientsInfo();
        }, 5000);
    }
    
    // Reload page data after a short delay
    setTimeout(() => {
        window.location.reload();
    }, 1000);
}

// Missing bulk operation functions
function bulkRemoveFromGroup() {
    if (selectedClients.length === 0) {
        showNotification('No clients selected', 'warning');
        return;
    }
    
    if (confirm(`Remove ${selectedClients.length} clients from their groups?`)) {
        showProgress('Removing clients from groups...');
        
        fetch('/api/bulk_assign_group', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                clients: selectedClients,
                group: '' // Empty group = remove from group
            })
        })
        .then(response => response.json())
        .then(data => {
            hideProgress();
            bootstrap.Modal.getInstance(document.getElementById('bulkOperationsModal')).hide();
            
            if (data.success) {
                showNotification(`Successfully removed ${selectedClients.length} clients from groups!`, 'success');
                setTimeout(() => window.location.reload(), 1500);
            } else {
                showNotification('Error: ' + data.error, 'error');
            }
        })
        .catch(error => {
            hideProgress();
            showNotification('Connection error: ' + error.message, 'error');
        });
    }
}

function bulkRenewCertificates() {
    if (selectedClients.length === 0) {
        showNotification('No clients selected', 'warning');
        return;
    }
    
    if (confirm(`Renew certificates for ${selectedClients.length} clients?`)) {
        showProgress('Renewing certificates...');
        
        // This would need to be implemented in the backend
        setTimeout(() => {
            hideProgress();
            showNotification(`Certificate renewal for ${selectedClients.length} clients initiated!`, 'success');
            bootstrap.Modal.getInstance(document.getElementById('bulkOperationsModal')).hide();
        }, 2000);
    }
}

function bulkRevokeClients() {
    if (selectedClients.length === 0) {
        showNotification('No clients selected', 'warning');
        return;
    }
    
    if (confirm(`REVOKE ${selectedClients.length} clients? This action cannot be undone!`)) {
        showProgress('Revoking clients...');
        
        // This would need to be implemented in the backend
        setTimeout(() => {
            hideProgress();
            showNotification(`${selectedClients.length} clients revoked!`, 'warning');
            bootstrap.Modal.getInstance(document.getElementById('bulkOperationsModal')).hide();
            setTimeout(() => window.location.reload(), 1500);
        }, 2000);
    }
}

function bulkChangeProfile() {
    if (selectedClients.length === 0) {
        showNotification('No clients selected', 'warning');
        return;
    }
    
    const profiles = ['standard', 'high_bandwidth', 'restricted', 'mobile_only', 'admin_access', 'guest_limited'];
    const profileSelect = profiles.map(p => `<option value="${p}">${p.replace('_', ' ')}</option>`).join('');
    
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Change Profile for ${selectedClients.length} clients</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="newProfile" class="form-label">Select New Profile:</label>
                        <select class="form-select" id="newProfile">
                            ${profileSelect}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="applyProfileChange()">Apply Changes</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
    
    modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
    });
}

function bulkDownloadConfigs() {
    if (selectedClients.length === 0) {
        showNotification('No clients selected', 'warning');
        return;
    }
    
    showProgress('Preparing configuration files...');
    
    // Simulate bulk download
    setTimeout(() => {
        hideProgress();
        showNotification(`Configuration files for ${selectedClients.length} clients prepared!`, 'success');
        bootstrap.Modal.getInstance(document.getElementById('bulkOperationsModal')).hide();
    }, 2000);
}

function bulkExportSelected() {
    if (selectedClients.length === 0) {
        showNotification('No clients selected', 'warning');
        return;
    }
    
    showProgress('Exporting selected clients...');
    
    const csvContent = 'Client Name,Status,Group,Profile\n' + 
        selectedClients.map(name => `${name},Active,users,standard`).join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `selected-clients-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    hideProgress();
    showNotification(`${selectedClients.length} clients exported!`, 'success');
    bootstrap.Modal.getInstance(document.getElementById('bulkOperationsModal')).hide();
}

function bulkGenerateReport() {
    if (selectedClients.length === 0) {
        showNotification('No clients selected', 'warning');
        return;
    }
    
    showProgress('Generating report...');
    
    setTimeout(() => {
        hideProgress();
        showNotification(`Report for ${selectedClients.length} clients generated!`, 'success');
        bootstrap.Modal.getInstance(document.getElementById('bulkOperationsModal')).hide();
    }, 2000);
}

// Initialize enhanced features on page load
document.addEventListener('DOMContentLoaded', function() {
    // Add custom styles for enhanced features
    const style = document.createElement('style');
    style.textContent = `
        .template-card {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .template-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }
        
        .template-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .template-features {
            list-style: none;
            padding: 0;
            text-align: left;
            font-size: 0.875rem;
        }
        
        .template-features li {
            margin-bottom: 0.25rem;
        }
        
        .client-group-badge, .client-profile-badge {
            font-size: 0.7rem;
        }
        
        .bulk-operation-btn {
            width: 100%;
            margin-bottom: 0.5rem;
        }
        
        .stat-card {
            padding: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
        }
    `;
    document.head.appendChild(style);
    
    // Initialize auto-refresh if enabled
    if (autoRefreshEnabled) {
        updateInterval = setInterval(() => {
            updateClientsData();
            updateTemporaryClientsInfo();
        }, 5000);
    }
});
</script>
{% endblock %} 